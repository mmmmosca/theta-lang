# Turing Machine simulator in Theta
# Tape is a Theta array of symbols (numbers). Blank symbol = 0.

# build_prefix(i, n, tape): return tape[0:i]
build_prefix(i,n,tape) -> { return [] when i >= n else [ tape[i] ] + build_prefix(i+1, n, tape) }

# build_from(i, tape): return tape[i:]
build_from(i,tape) -> { return [] when i >= len(tape) else [ tape[i] ] + build_from(i+1, tape) }

# write(tape, pos, val): return new tape where tape[pos] = val (functional)
write(tape,pos,val) -> { left = build_prefix(0, pos, tape); right = build_from(pos+1, tape); return left + [val] + right }

# get_transition(trans, state, symbol): linear search over transition list
# Each transition: [state, symbol, new_symbol, dir, next_state]
# For this simple example, use an explicit transition function instead of a table
get_transition(_, state, symbol) -> { return ['q0',1,1,1,'q0'] when state == 'q0' and symbol == 1 else ['q0',0,1,0,'qa'] when state == 'q0' and symbol == 0 else [] }

# step(tape, head, state, trans) -> (tape2, head2, state2, halted_flag)
step(tape, head, state, trans) -> { tr = get_transition(trans, state, tape[head]); return (tape, head, state, 1) when tr == [] else ( write(tape, head, tr[2]), head + tr[3], tr[4], 0 ) }

# simulate(tape, head, state, trans, steps): perform up to `steps` steps
simulate(tape, head, state, trans, steps) -> { return (tape, head, state) when steps <= 0 else ( return (step(tape, head, state, trans)[0], step(tape, head, state, trans)[1], step(tape, head, state, trans)[2]) when step(tape, head, state, trans)[3] == 1 else simulate(step(tape, head, state, trans)[0], step(tape, head, state, trans)[1], step(tape, head, state, trans)[2], trans, steps - 1) ) }

# Sample TM: unary increment. Symbols: 1 for mark, 0 for blank.
# Behavior: move right over 1s, when blank -> write 1 and halt.

let tape = [[1;1;1;0;0;0]]
let head = 0
let state = 'q0'

io.out("final tape:", simulate(tape, head, state, [], 100)[0])
io.out("final head:", simulate(tape, head, state, [], 100)[1])
io.out("final state:", simulate(tape, head, state, [], 100)[2])
